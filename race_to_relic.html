<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Race to the Relic — AoS4 (500 pt)</title>
  <!-- Favicon Link -->
  <link rel="icon" href="images/Invert_Small_Logo.png" type="image/png"> <!-- Assuming favicon is in /images -->

  <!-- Google Fonts import: Quantico for headings, Roboto for body -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Quantico:wght@400;700&display=swap" rel="stylesheet">
  <style>
    /* CSS Variables for easy theme changes (matches club theme) */
    :root {
        --bg-color: #000000; /* Main page background */
        --block-bg-color: #1a1a1a; /* Background for content blocks */
        --text-color: #FFFFFF; /* Main white text */
        --link-color: #A0A0A0; /* Light grey for links */
        --link-hover-color: #FFFFFF; /* White on hover */
        --accent-color: #D3D3D3; /* Light grey accent for borders/details */
        --input-bg-color: #3f3f3f; /* Lighter dark for input fields */
        --button-primary: #008CBA; /* Blue from CTA buttons */
        --button-primary-hover: #007bb5;
        --button-secondary: #7f2a2a; /* Reddish brown for specific actions */
        --button-secondary-hover: #6a2424;

        --font-main: 'Roboto', sans-serif;
        --font-display: 'Quantico', sans-serif; /* Military-style font for headings */
    }

    /* CSS to hide the honeypot field */
    .hidden {
        display: none;
    }

    /* Basic page */
    html,body{
      margin:0;
      padding:0;
      font-family: var(--font-main);
      background-color: var(--bg-color); /* Apply main black background */
      color: var(--text-color);
      line-height: 1.6;
      scroll-behavior: smooth;
    }

    .container{
      max-width: 1200px;
      margin: 18px auto;
      padding: 10px;
      box-sizing: border-box;
    }

    /* The main page wrapper, now flows content in a single column */
    .page {
      padding: 0;
      box-shadow: none;
      border: none;
      background: none;
      display: flex;
      flex-direction: column;
      gap: 30px; /* Space between the main content blocks */
    }

    .title {
      color: var(--ink-red);
      font-family: var(--font-display);
      font-size: 1.8rem;
      font-weight:800;
      margin: 0 0 6px 0;
      letter-spacing: 0.5px;
      text-align: center;
      text-transform: uppercase;
    }
    .subtitle {
      color: var(--muted);
      font-size: 1rem;
      margin: 0 0 20px 0;
      text-align: center;
    }

    /* Standard section-block styling (matches index.html) */
    .section-block {
        background-color: var(--block-bg-color);
        border: 1px solid var(--accent-color);
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0, 255, 255, 0.05);
    }

    h2{
      font-family: var(--font-display);
      color: var(--text-color);
      text-align: center;
      margin-top: 0;
      margin-bottom: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-size: 1.5em;
      font-weight: 700;
      border-bottom: 1px solid var(--accent-color);
      padding-bottom: 8px;
    }
    h3 {
      font-family: var(--font-display);
      font-size: 1.2em;
      text-align: left;
      letter-spacing: 1px;
      margin-top: 15px;
      margin-bottom: 10px;
    }

    p, li { font-size: 0.95rem; line-height:1.6; margin: 6px 0; color: var(--text-color); }
    ul { margin:6px 0 8px 18px; padding:0; }

    strong { color: var(--text-color); font-weight:700; }

    /* Map Image Section Styling (now also a section-block) */
    .map-image-section {
      text-align: center;
      /* Inherits section-block styling */
    }
    .map-image-section h2 {
      text-align: center;
    }
    .map-image-section img {
      max-width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
      border: 1px solid var(--accent-color);
      border-radius: 4px;
    }
    .map-image-section p {
      font-size: 0.9rem;
      color: var(--muted);
      margin-top: 10px;
    }

    /* General Button Styling (consolidated) */
    .action-button {
        background-color: var(--button-secondary);
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-family: var(--font-display);
        font-size: 0.95rem;
        font-weight: bold;
        margin: 8px 0;
        width: 100%;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: background-color 0.2s ease;
    }
    .action-button:hover {
        background-color: var(--button-secondary-hover);
    }
    /* Specific button overrides */
    .start-game-button, .confirm-players-button {
      background-color: var(--button-primary);
    }
    .start-game-button:hover, .confirm-players-button:hover {
      background-color: var(--button-primary-hover);
    }
    .pdf-button {
      background-color: var(--link-color);
    }
    .pdf-button:hover {
      background-color: var(--muted);
    }


    /* Player Selection & Game UI Styling (now also a section-block) */
    .player-selection-panel, .game-tracking-panel {
        background-color: var(--block-bg-color); /* Matches section-block */
        border: 1px solid var(--accent-color);
        border-radius: 8px;
        padding: 20px;
        color: var(--text-color);
        margin-top: 20px; /* Consistent margin for this interactive block */
    }
    .player-selection-panel h3, .game-tracking-panel h3, .game-tracking-panel h4 {
        color: var(--text-color);
        font-family: var(--font-display);
        text-align: center;
        margin-bottom: 15px;
        margin-top: 0;
    }
    .game-tracking-panel h4 { /* Player names */
        text-align: left;
        margin-top: 20px;
        margin-bottom: 10px;
        font-size: 1.1em;
        color: var(--text-color);
        font-family: var(--font-main);
        text-transform: none;
        letter-spacing: normal;
        font-weight: 700;
    }
    .player-selection-panel label, .game-tracking-panel label {
        display: block;
        margin-bottom: 5px;
        font-weight: 700;
        color: var(--text-color);
        font-family: var(--font-main);
        font-size: 0.95em;
        letter-spacing: normal;
    }
    .player-selection-panel select,
    .game-tracking-panel input[type="number"],
    .game-tracking-panel input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--accent-color);
        border-radius: 4px;
        background-color: var(--input-bg-color);
        color: var(--text-color);
        font-family: var(--font-main);
        font-size: 1em;
        -webkit-appearance: none;
        -moz-appearance: textfield;
    }
    .player-selection-panel select option {
        background-color: var(--input-bg-color);
        color: var(--text-color);
    }
    .player-score-controls {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
    }
    .player-score-controls button {
        background-color: var(--button-primary);
        color: white;
        border: none;
        padding: 8px 14px;
        border-radius: 4px;
        cursor: pointer;
        font-family: var(--font-display);
        font-size: 1em;
        transition: background-color 0.2s;
    }
    .player-score-controls button:hover {
        background-color: var(--button-primary-hover);
    }
    .player-score-controls input[type="number"] {
        flex-grow: 1;
        text-align: center;
    }
    .current-round-display {
        font-family: var(--font-display);
        font-size: 1.2em;
        text-align: center;
        margin-bottom: 15px;
        padding: 8px;
        border: 1px solid var(--accent-color);
        background-color: var(--input-bg-color);
        color: var(--text-color);
        border-radius: 4px;
    }

    .notes { font-size: 0.88rem; color: var(--muted); margin-top: 8px; }


    /* Responsive adjustments */
    @media (max-width: 800px){
      .page{ gap: 20px; }
      .title{ font-size: 1.5rem; }
      .subtitle{ font-size: 0.9rem; }
      h2{ font-size: 1.2em; margin-bottom: 15px;}
      p, li { font-size: 0.9em; }
      .container{ margin: 8px; padding: 5px;}
      .section-block { padding: 15px; }
      .action-button { padding: 8px 10px; font-size: 0.9em; }
      .player-selection-panel, .game-tracking-panel { padding: 15px; }
      .player-score-controls button { padding: 6px 10px; font-size: 0.85em; }
      .player-selection-panel select, .game-tracking-panel input[type="number"], .game-tracking-panel input[type="text"] { font-size: 0.9em; padding: 8px; }
    }

    @media (max-width: 420px){
      .title{ font-size: 1.2rem; }
      .subtitle{ font-size: 0.85rem; }
      p, li { font-size: 0.85em; }
      h2{ font-size: 1.1em; }
      .action-button { font-size: 0.85em; padding: 6px 8px; }
      .player-score-controls button { font-size: 0.8em; padding: 5px 8px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="page" role="main" aria-label="Race to the Relic scenario">
      <!-- Page Title & Subtitle (now in a section-block for consistent styling) -->
      <section class="section-block" style="margin-bottom:0;"> 
        <div class="title">Race to the Relic — Age of Sigmar 4 (500 pt)</div>
        <div class="subtitle">Fast racing scenario for 500‑point warbands — web/mobile friendly</div>
      </section>

      <!-- 1st: Rules & Setup Section -->
      <section class="section-block">
        <h2>Setup</h2>
        <p><strong>Points:</strong> 500 pts per player or Spearhead vs Spearhead.</p>
        <p><strong>Board size:</strong> 4' x 4' recommended (use 4' x 6' if you want more running room).</p>
        <p class="muted">Terrain: LOS blockers so no army can be seen at deployment.</p>

        <h2>Deployment &amp; Relic placement</h2>
        <p>Place the <strong>Relic</strong> on the centreline, <strong>6"</strong> from the short table edge of the player who goes second. Deployment follows normal rules. The first player may move toward the Relic but <strong>cannot pick it up on Turn 1</strong>.</p>

        <h2>Special Rules (Relic &amp; Carrying)</h2>
        <ul>
          <li><strong>Picking up:</strong> A model can pick up the Relic if it ends a Move or Charge within <strong>1"</strong> of it.</li>
          <li><strong>Carrying:</strong> Only the designated model is the carrier. Carrier’s Movement is reduced by <strong>1"</strong> and the carrier <strong>cannot run</strong>.</li>
          <li class="muted">Flying: Flying units lose their Flying keyword while carrying the Relic; the relic is too heavy to lift.</li>
          <li><strong>Dropping:</strong> Carrier may drop at the end of its Movement; if removed from play the Relic drops where it left play.</li>
          <li><strong>Teleporting:</strong> A unit cannot be teleported while carrying the Relic. If a rule attempts to teleport a unit that has the Relic, the Relic is dropped at the unit's original location instead.</li>
          <li><strong>Contested:</strong> If within <strong>3"</strong> of models from both players the Relic is contested and cannot be delivered.</li>
          <li><strong>Relic Combat:</strong> If the unit carrying the Relic is engaged in combat, it may forgo fighting to make a break‑free attempt: after all eligible units have taken their combat actions, the carrier may attempt to break free and move its Movement characteristic to disengage (subject to core break‑free rules).</li>
        </ul>

        <h2>Turn &amp; First Turn</h2>
        <p>Game uses the normal core turn sequence. <strong>First player cannot pick up the Relic on Turn 1.</strong></p>

        <h2>Victory Conditions</h2>
        <p><strong>Immediate race win:</strong> If at the end of your Movement phase you have the Relic within <strong>3"</strong> of your opponent’s short edge and you control it (not contested), you immediately win.</p>
        <p class="muted">If no immediate winner by end of Round 6, score points:</p>
        <ul>
          <li>3 pts — Relic is in opponent’s half (beyond centreline)</li>
          <li>2 pts — Controls Relic (carrier or uncontested presence within 3") at game end</li>
          <li>1 pt — More models within 6" of the Relic at game end</li>
          <li>Tiebreaker: most battleline units remaining, then defender of deployment if still tied</li>
        </ul>
      </section>

      <!-- 2nd: Battleplan Map Section -->
      <section class="section-block map-image-section">
        <h2>Battleplan Map</h2>
        <img src="your-map-image-url.jpg" alt="Battleplan map for Race to the Relic scenario" />
        <p><strong>Map Key &amp; Placement:</strong>/images/bp_relicrace.jpg</p>
      </section>

      <!-- 3rd: Player Input / Game Tracking Section -->
      <section id="game-controls-section" class="section-block">
        <button class="action-button start-game-button" id="startGameButton">Start New Game!</button>

        <div id="playerSelection" class="player-selection-panel" style="display:none;">
          <h3>Select Players</h3>
          <div class="form-group">
            <label for="player1Select">Player 1:</label>
            <select id="player1Select" required>
              <option value="">-- Select Player 1 --</option>
            </select>
          </div>
          <div class="form-group">
            <label for="player2Select">Player 2:</label>
            <select id="player2Select" required>
              <option value="">-- Select Player 2 --</option>
            </select>
          </div>
          <button class="action-button confirm-players-button" id="confirmPlayersButton">Confirm Players</button>
          <p id="playerSelectionError" style="color:red; font-size:0.85em; margin-top:10px; display:none;">Players cannot be the same.</p>
        </div>

        <div id="gameTrackingUI" class="game-tracking-panel" style="display:none;">
          <h3 id="gameTitle">Game in Progress</h3>
          <div class="current-round-display">Round: <span id="currentRound">1</span></div>

          <h4><span id="player1NameDisplay">Player 1</span></h4>
          <div class="form-group">
              <label for="player1CP">Command Points:</label>
              <div class="player-score-controls">
                  <button onclick="changeValue('player1CP', -1)">-</button>
                  <input type="number" id="player1CP" value="0" min="0">
                  <button onclick="changeValue('player1CP', 1)">+</button>
              </div>
          </div>
          <div class="form-group">
              <label for="player1Score">Victory Points:</label>
              <div class="player-score-controls">
                  <button onclick="changeValue('player1Score', -1)">-</button>
                  <input type="number" id="player1Score" value="0" min="0">
                  <button onclick="changeValue('player1Score', 1)">+</button>
              </div>
          </div>

          <h4><span id="player2NameDisplay">Player 2</span></h4>
          <div class="form-group">
              <label for="player2CP">Command Points:</label>
              <div class="player-score-controls">
                  <button onclick="changeValue('player2CP', -1)">-</button>
                  <input type="number" id="player2CP" value="0" min="0">
                  <button onclick="changeValue('player2CP', 1)">+</button>
              </div>
          </div>
          <div class="form-group">
              <label for="player2Score">Victory Points:</label>
              <div class="player-score-controls">
                  <button onclick="changeValue('player2Score', -1)">-</button>
                  <input type="number" id="player2Score" value="0" min="0">
                  <button onclick="changeValue('player2Score', 1)">+</button>
              </div>
          </div>
          
          <button class="action-button end-round-button" id="endRoundButton">End Round</button>
          <button class="action-button end-game-button" id="endGameButton">End Game & Submit</button>
        </div>
      </section>

      <!-- 4th: Balance Tips Section -->
      <section class="section-block">
        <h2>Balance Tips</h2>
        <ul>
          <li>Ban or limit extreme teleport/mobility in small 500pt games if needed for fairness.</li>
          <li>Use terrain to create chokepoints and slow direct sprints.</li>
          <li>Optionally increase the carrier penalty to −2" for units with Movement over 9".</li>
        </ul>
      </section>

      <!-- 5th: PDF Button & Quick Tactics/FAQ Section -->
      <section class="section-block">
        <button class="action-button pdf-button" onclick="window.print()">Save as PDF</button>

        <div class="notes">
          <strong>Quick tactics:</strong> use a fast skirmisher as carrier with screens; reserve an interceptor for your edge; use displacement to slow enemy carriers.
        </div>

        <button class="collapsible" aria-expanded="false" onclick="toggleCollapsible(this)">Quick FAQ & examples</button>
        <div class="content">
          <p><strong>Q:</strong> Can the carrier shoot? <br><strong>A:</strong> Yes, subject to normal rules — but remember the carrier cannot run and has −1" Movement.</p>
          <p><strong>Q:</strong> What happens if a carrier is removed in melee? <br><strong>A:</strong> The Relic drops where the model was removed and can be picked up by eligible models.</p>
        </div>
      </section>

    </div>
  </div>

  <script>
    // --- Global Variables ---
    let allPlayers = []; // Stores loaded players from players.json
    let gameData = {
        player1: null,
        player2: null,
        currentRound: 1,
        player1CP: 0,
        player1Score: 0,
        player2CP: 0,
        player2Score: 0,
        battleplan: 'Race to the Relic' // This scenario's name
    };

    // --- DOM Element References ---
    const startGameButton = document.getElementById('startGameButton');
    const playerSelectionPanel = document.getElementById('playerSelection');
    const player1Select = document.getElementById('player1Select');
    const player2Select = document.getElementById('player2Select');
    const confirmPlayersButton = document.getElementById('confirmPlayersButton');
    const playerSelectionError = document.getElementById('playerSelectionError');
    const gameTrackingUI = document.getElementById('gameTrackingUI');
    const gameTitleDisplay = document.getElementById('gameTitle');
    const currentRoundDisplay = document.getElementById('currentRound');
    const player1NameDisplay = document.getElementById('player1NameDisplay');
    const player2NameDisplay = document.getElementById('player2NameDisplay');
    const player1CPInput = document.getElementById('player1CP');
    const player1ScoreInput = document.getElementById('player1Score');
    const player2CPInput = document.getElementById('player2CP');
    const player2ScoreInput = document.getElementById('player2Score');
    const endRoundButton = document.getElementById('endRoundButton');
    const endGameButton = document.getElementById('endGameButton');

    // --- Utility Functions ---
    function toggleCollapsible(btn){
      const expanded = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', String(!expanded));
    }

    function changeValue(inputId, delta) {
        const input = document.getElementById(inputId);
        let currentValue = parseInt(input.value) || 0;
        input.value = Math.max(0, currentValue + delta); // Prevent negative scores/CP
    }

    // --- Main Game Logic ---

    // Loads players into dropdowns
    async function loadPlayersIntoDropdowns() {
        try {
            const response = await fetch('players.json'); // Fetch from root
            allPlayers = await response.json();

            // Clear existing options
            player1Select.innerHTML = '<option value="">-- Select Player 1 --</option>';
            player2Select.innerHTML = '<option value="">-- Select Player 2 --</option>';

            allPlayers.forEach(player => {
                const option1 = document.createElement('option');
                option1.value = player.id;
                option1.textContent = `${player.name} (${player.warband_name || player.faction})`;
                player1Select.appendChild(option1);

                const option2 = document.createElement('option');
                option2.value = player.id;
                option2.textContent = `${player.name} (${player.warband_name || player.faction})`;
                player2Select.appendChild(option2);
            });

        } catch (error) {
            console.error('Error loading players:', error);
            alert('Failed to load player list. Please try again later.');
            startGameButton.disabled = true; // Disable start game if players can't load
        }
    }

    // Starts the game by showing player selection
    startGameButton.addEventListener('click', () => {
        startGameButton.style.display = 'none';
        playerSelectionPanel.style.display = 'block';
        loadPlayersIntoDropdowns();
    });

    // Confirms player selection and shows game tracking UI
    confirmPlayersButton.addEventListener('click', () => {
        const p1Id = player1Select.value;
        const p2Id = player2Select.value;

        if (!p1Id || !p2Id) {
            playerSelectionError.textContent = 'Please select both players.';
            playerSelectionError.style.display = 'block';
            return;
        }

        if (p1Id === p2Id) {
            playerSelectionError.textContent = 'Players cannot be the same. Please select different players.';
            playerSelectionError.style.display = 'block';
            return;
        }

        playerSelectionError.style.display = 'none';

        // Find selected player objects
        gameData.player1 = allPlayers.find(p => p.id === p1Id);
        gameData.player2 = allPlayers.find(p => p.id === p2Id);

        if (!gameData.player1 || !gameData.player2) {
            playerSelectionError.textContent = 'Selected players not found. Please reload.';
            playerSelectionError.style.display = 'block';
            return;
        }

        // Initialize UI with player names
        player1NameDisplay.textContent = gameData.player1.name;
        player2NameDisplay.textContent = gameData.player2.name;
        gameTitleDisplay.textContent = `${gameData.player1.name} (${gameData.player1.warband_name || gameData.player1.faction}) vs ${gameData.player2.name} (${gameData.player2.warband_name || gameData.player2.faction})`;


        // Hide player selection, show game tracking
        playerSelectionPanel.style.display = 'none';
        gameTrackingUI.style.display = 'block';
    });

    // Ends a round, increments round counter
    endRoundButton.addEventListener('click', () => {
        // You might want to add a confirmation here
        gameData.currentRound++;
        currentRoundDisplay.textContent = gameData.currentRound;
        alert(`Round ${gameData.currentRound - 1} ended. Starting Round ${gameData.currentRound}.`);
        // Reset CP or take other end-of-round actions if needed
        // For simplicity, CP is not reset automatically here, but you can add that logic.
    });

    // Ends the game and prepares for submission
    endGameButton.addEventListener('click', () => {
        const confirmEnd = confirm("Are you sure you want to end the game and submit results?");
        if (!confirmEnd) return;

        // Capture final scores
        gameData.player1CP = parseInt(player1CPInput.value);
        gameData.player1Score = parseInt(player1ScoreInput.value);
        gameData.player2CP = parseInt(player2CPInput.value);
        gameData.player2Score = parseInt(player2ScoreInput.value);

        // Prepare data for submission page (simplified to just player IDs and scores)
        const submissionData = {
            player1_id: gameData.player1.id,
            player1_name: gameData.player1.name,
            player1_score: gameData.player1Score, // This is the campaign points for Player 1
            
            player2_id: gameData.player2.id,
            player2_name: gameData.player2.name,
            player2_score: gameData.player2Score, // This is the campaign points for Player 2

            battleplan_name: gameData.battleplan,
            total_rounds: gameData.currentRound // Total rounds played
        };

        // Store submission data in sessionStorage to pass to submit_game.html
        sessionStorage.setItem('gameSubmissionData', JSON.stringify(submissionData));

        // Redirect to the submission page
        window.location.href = 'submit_game.html';
    });


    // --- Initialization on Page Load ---
    document.addEventListener('DOMContentLoaded', () => {
        // Load players initially (e.g., if we want to show player names directly in gameTrackingUI without selection)
        // For now, players are loaded when "Start Game" is clicked.
        // The collapsible FAQ is also initialized here:
        const collapsibles = document.querySelectorAll('.collapsible');
        collapsibles.forEach(btn => {
          btn.addEventListener('click', () => toggleCollapsible(btn));
        });
    });
  </script>
</body>
</html>
