<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Battleplan: The Ritual (AoS v4) - The Dirty d6 Dozen</title>
    <!-- Favicon Link -->
    <link rel="icon" href="images/Invert_Small_Logo.png" type="image/png">
    
    <!-- Google Fonts import: Quantico for headings, Roboto for body -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Quantico:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Variables for easy theme changes (matches club theme) */
        :root {
            --bg-color: #000000; /* Main page background */
            --block-bg-color: #1a1a1a; /* Background for content blocks */
            --text-color: #FFFFFF; /* Main white text */
            --link-color: #A0A0A0; /* Light grey for links */
            --link-hover-color: #FFFFFF; /* White on hover */
            --accent-color: #D3D3D3; /* Light grey accent for borders/details */
            --input-bg-color: #3f3f3f; /* Lighter dark for input fields */
            --button-primary: #008CBA; /* Blue from CTA buttons */
            --button-primary-hover: #007bb5;
            --button-secondary: #7f2a2a; /* Reddish brown for specific actions */
            --button-secondary-hover: #6a2424;

            --font-main: 'Roboto', sans-serif;
            --font-display: 'Quantico', sans-serif; /* Military-style font for headings */
        }

        /* CSS to hide the honeypot field */
        .hidden {
            display: none;
        }

        /* Basic page */
        html,body{
            margin:0;
            padding:0;
            font-family: var(--font-main);
            background-color: var(--bg-color); /* Apply main black background */
            color: var(--text-color);
            line-height: 1.6;
            scroll-behavior: smooth;
        }

        .container{ /* General container for content width */
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px; /* Added horizontal padding to container */
            box-sizing: border-box;
        }

        /* Header Styling */
        header {
            background-color: var(--bg-color);
            padding: 20px 0; /* Padding handled by header itself */
            text-align: center;
        }

        .banner-img {
            max-width: 90%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        /* Navigation Styling */
        nav {
            background-color: var(--bg-color);
            padding: 10px 0; /* Padding handled by nav itself */
            text-align: center;
            border-top: 1px solid var(--accent-color);
            border-bottom: 1px solid var(--accent-color);
            margin-bottom: 30px;
        }

        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        nav ul li {
            display: inline-block;
            margin: 0 15px;
        }

        nav ul li a {
            color: var(--link-color);
            text-decoration: none;
            font-weight: 700;
            font-size: 1.1em;
            transition: color 0.3s ease;
            font-family: var(--font-display);
        }

        nav ul li a:hover {
            color: var(--link-hover-color);
        }

        main { /* Main content area, now only a flex container for sections */
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 30px; /* Space between main sections */
        }

        .title {
            color: var(--ink-red);
            font-family: var(--font-display);
            font-size: 1.8rem;
            font-weight:800;
            margin: 0 0 6px 0;
            letter-spacing: 0.5px;
            text-align: center;
            text-transform: uppercase;
        }
        .subtitle {
            color: var(--muted);
            font-size: 1rem;
            margin: 0 0 20px 0;
            text-align: center;
        }

        /* Standard section-block styling */
        .section-block {
            background-color: var(--block-bg-color);
            border: 1px solid var(--accent-color);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 255, 255, 0.05);
        }

        h2{
            font-family: var(--font-display);
            color: var(--text-color);
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.5em;
            font-weight: 700;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 8px;
        }
        h3 {
            font-family: var(--font-display);
            color: var(--text-color); /* Ensure h3 is visible */
            font-size: 1.2em;
            text-align: left;
            letter-spacing: 1px;
            margin-top: 15px;
            margin-bottom: 10px;
        }

        h4 { /* For player names in tracking UI */
            font-family: var(--font-display);
            font-size: 1.1em;
            text-align: center;
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--link-hover-color);
        }


        p, li { font-size: 0.95rem; line-height:1.6; margin: 6px 0; color: var(--text-color); }
        ul { margin:6px 0 8px 18px; padding:0; }

        strong { color: var(--text-color); font-weight:700; }

        /* Map Image Section Styling */
        .map-section {
          text-align: center;
        }
        .map-section img {
          max-width: 100%;
          height: auto;
          display: block;
          margin: 0 auto;
          border: 1px solid var(--accent-color);
          border-radius: 4px;
        }
        .map-section p {
          font-size: 0.9rem;
          color: var(--muted);
          margin-top: 10px;
        }

        /* General Button Styling (consolidated) */
        .action-button {
            background-color: var(--button-secondary);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-display);
            font-size: 0.95rem;
            font-weight: bold;
            margin: 8px 0;
            width: 100%;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease;
        }
        .action-button:hover {
            background-color: var(--button-secondary-hover);
        }
        /* Specific button overrides */
        .start-game-button, .confirm-players-button {
          background-color: var(--button-primary);
        }
        .start-game-button:hover, .confirm-players-button:hover {
          background-color: var(--button-primary-hover);
        }
        .pdf-button { /* PDF button is also an action-button */
          background-color: var(--link-color);
        }
        .pdf-button:hover {
          background-color: var(--muted);
        }


        /* Player Selection & Game UI Styling */
        .player-selection-panel, .game-tracking-panel {
            background-color: var(--block-bg-color);
            border: 1px solid var(--accent-color);
            border-radius: 8px;
            padding: 20px;
            color: var(--text-color);
        }
        .player-selection-panel h3, .game-tracking-panel h3 {
            color: var(--text-color);
            font-family: var(--font-display);
            text-align: center;
            margin-bottom: 15px;
            margin-top: 0;
        }
        .player-selection-panel label, .game-tracking-panel label {
            display: block;
            margin-bottom: 5px;
            font-weight: 700;
            color: var(--text-color);
            font-family: var(--font-main);
            font-size: 0.95em;
            letter-spacing: normal;
        }
        .player-selection-panel select,
        .game-tracking-panel input[type="number"],
        .game-tracking-panel input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--accent-color);
            border-radius: 4px;
            background-color: var(--input-bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            font-size: 1em;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        .player-selection-panel select option {
            background-color: var(--input-bg-color);
            color: var(--text-color);
        }
        .player-score-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .player-score-controls button {
            background-color: var(--button-primary);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-display);
            font-size: 1em;
            transition: background-color 0.2s;
        }
        .player-score-controls button:hover {
            background-color: var(--button-primary-hover);
        }
        .player-score-controls input[type="number"] {
            flex-grow: 1;
            text-align: center;
        }
        .current-round-display {
            font-family: var(--font-display);
            font-size: 1.2em;
            text-align: center;
            margin-bottom: 15px;
            padding: 8px;
            border: 1px solid var(--accent-color);
            background-color: var(--input-bg-color);
            color: var(--text-color);
            border-radius: 4px;
        }

        .notes { font-size: 0.88rem; color: var(--muted); margin-top: 8px; }

        /* Footer styling */
        footer {
            background-color: #0d0d0d;
            color: var(--link-color);
            text-align: center;
            padding: 25px 0;
            border-top: 1px solid var(--accent-color);
            margin-top: 40px;
        }

        .footer-logo {
            max-width: 60px;
            height: auto;
            margin-top: 15px;
            opacity: 0.8;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        
        /* Call-to-action button container styling */
        .call-to-action {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        /* Standard CTA button style */
        .cta-button {
            display: inline-block;
            background-color: var(--button-primary);
            color: var(--text-color);
            padding: 15px 30px;
            text-decoration: none;
            font-family: var(--font-display);
            font-size: 1.2em;
            border-radius: 5px;
            transition: background-color 0.3s ease, transform 0.2s ease;
            letter-spacing: 1px;
            font-weight: 700;
            max-width: 300px;
            box-sizing: border-box;
        }

        .cta-button:hover {
            background-color: var(--button-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 255, 255, 0.2);
        }

        /* Responsive adjustments */
        @media (max-width: 800px){
          main { gap: 20px; }
          .title{ font-size: 1.5rem; }
          .subtitle{ font-size: 0.9rem; }
          h2{ font-size: 1.2em; margin-bottom: 15px;}
          p, li { font-size: 0.9em; }
          .container{ margin: 8px; padding: 5px;}
          .section-block { padding: 15px; }
          .action-button { padding: 8px 10px; font-size: 0.9em; }
          .player-selection-panel, .game-tracking-panel { padding: 15px; }
          .player-score-controls button { padding: 6px 10px; font-size: 0.85em; }
          .player-selection-panel select, .game-tracking-panel input[type="number"], .game-tracking-panel input[type="text"] { font-size: 0.9em; padding: 8px; }
          .cta-button { font-size: 1em; padding: 12px 25px; max-width: 100%; }
        }

        @media (max-width: 420px){
          .title{ font-size: 1.2rem; }
          .subtitle{ font-size: 0.85rem; }
          p, li { font-size: 0.85em; }
          h2{ font-size: 1.1em; }
          .action-button { font-size: 0.85em; padding: 6px 8px; }
          .player-score-controls button { font-size: 0.8em; padding: 5px 8px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <img src="images/DD6completeinvert.png" alt="The Dirty d6 Dozen Club Banner" class="banner-img" />
        </div>
    </header>

    <nav>
        <div class="container">
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#about">About Us</a></li>
                <li><a href="events_campaigns.html">Events & Campaigns</a></li>
                <li><a href="past_events.html">Past Events</a></li>
                <li><a href="index.html#contact">Contact</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <!-- Battleplan Title & Subtitle Section -->
        <section class="section-block" style="margin-bottom:0;">
            <div class="title">Battleplan: The Ritual</div>
            <div class="subtitle">An Age of Sigmar Narrative Mission</div>
        </section>

        <!-- New: Campaign Introduction/Context -->
        <section class="section-block">
            <h2>Across the Mortal Realms...</h2>
            <p>...the gods look on as their worshippers fight and die in their name. Should the correct rituals be performed, it will surely spell destruction for their foes. This battleplan pits two forces against each other in a desperate race against time to either complete or disrupt a potent arcane ritual!</p>
            <h3>The Armies</h3>
            <p>Each player selects an army of an agreed-upon points value (e.g., <strong>1000 or 2000 points</strong>). Players then decide who will be the <strong>Ritualist</strong> and who will be the <strong>Disrupter</strong>. If one player's army has a significantly higher total points value (e.g., <strong>25% more or more</strong>), that player must be the Disrupter. Otherwise, both players roll a D6, and the player who rolls higher chooses whether to be the Ritualist or the Disrupter.</p>
            <p>Each General (or designated leader) has a unique Command Ability available to them, in addition to any others they may possess.</p>
        </section>

        <!-- New: Objectives Overview -->
        <section class="section-block">
            <h2>Objectives</h2>
            <h3>Ritualist's Objectives</h3>
            <p>You are on the verge of completing a powerful ritual to achieve your destiny. Your primary goal is to **complete the ritual (see 'The Ritual' rule below)**. You must fight through the enemy to protect the Artefact and finish what you started!</p>
            <h3>Disrupter's Objectives</h3>
            <p>Your mighty warhost is tasked with preventing a hated foe from completing a dire ritual. Your primary goal is to **Shatter the Artefact (see 'Shatter the Artefact' Command Ability below)**. Fight your way past the Ritualist's forces and destroy the focus of their ceremony!</p>
        </section>

        <!-- 1st: Rules & Setup Section -->
        <section class="section-block">
            <h2>The Battlefield & Setup</h2>
            <p>The battle takes place near an ancient, tainted artefact. A suitable piece of Terrain (e.g., a Baleful Realmgate, large statue, or arcane device) is placed anywhere in the Ritualist's territory to represent the Artefact. No model may move through this terrain feature.</p>
            <p>Generate the rest of the scenery for this battle using the current Warhammer: Age of Sigmar Core Rules for Battle Scenery and Terrain Features.</p>

            <h3>Set-Up</h3>
            <p>Do not use the standard set-up instructions from the Core Rules. Instead, players take turns setting up units one at a time, starting with the player who deployed first. Your territory is defined by the map below. Units must be set up wholly within your own territory and more than <strong>9"</strong> from enemy territory. No model may deploy within <strong>3"</strong> of the Artefact.</p>
            
            <h3>First Turn</h3>
            <p>In the first battle round, the **Disrupter decides who will take the first turn.** (This overrides the standard roll-off for priority in the first battle round).</p>
        </section>

        <!-- 2nd: Battleplan Map Section -->
        <section class="section-block map-section">
            <h2>Battleplan Map</h2>
            <img src="images/the_ritual_map.jpg" alt="Battleplan map for The Ritual scenario (AoS v4)" />
            <p><strong>Map Overview:</strong> The battlefield is divided into two main territories. The Ritualist's territory (often red/orange) and the Disrupter's territory (often blue/grey). The Artefact is placed centrally, marking the heart of the conflict.</p>
        </section>

        <!-- New: Scoring Victory Points for AoS4 -->
        <section class="section-block">
            <h2>Scoring Victory Points</h2>
            <p>This battle lasts for 5 Battle Rounds. Each player should keep track of their Victory Points (VP) throughout the game. The player with the most VP at the end of Battle Round 5 wins!</p>

            <h3>1. Battleplan Objectives (Score at the end of each Battle Round)</h3>
            <ul>
                <li><strong>Ritualist's Progress:</strong> If the Artefact is wholly within the Ritualist's territory and is uncontested, the Ritualist scores <strong>3 Victory Points</strong>.</li>
                <li><strong>Ritualist's Protection:</strong> If the Ritualist's General is wholly within 12" of the Artefact, the Ritualist scores <strong>2 Victory Points</strong>.</li>
                <li><strong>Disrupter's Pressure:</b> If the Artefact is contested (i.e., within 3" of at least one Disrupter unit AND at least one Ritualist unit), the Disrupter scores <strong>3 Victory Points</strong>.</li>
                <li><strong>Disrupter's Advance:</strong> If the Disrupter's General is wholly within 12" of the Artefact, the Disrupter scores <strong>2 Victory Points</strong>.</li>
            </ul>

            <h3>2. End-Game Victory Points (Score at the end of Battle Round 5)</h3>
            <ul>
                <li><strong>Ritual Completed! (Ritualist):</strong> If the cumulative total of all Ritual rolls is 20 or more, the Ritualist scores an additional <strong>30 Victory Points</strong>.</li>
                <li><strong>Artefact Shattered! (Disrupter):</strong> If the Artefact was shattered by the Disrupter's Command Ability, the Disrupter scores an additional <strong>30 Victory Points</strong>.</li>
                <li><strong>Slay the Leadership:</strong> The player who slays the opposing player's General (original or any replacement) scores an additional <strong>10 Victory Points</strong>.</li>
                <li><strong>Control the Scene:</strong> The player who controls the Artefact (has more models within 3" of it) at the end of Battle Round 5 scores an additional <strong>5 Victory Points</strong>.</li>
            </ul>
            <p class="notes">Players also score Victory Points from their chosen Battle Tactics and Grand Strategies as per the Warhammer: Age of Sigmar Core Rules.</p>
        </section>


        <!-- New: Special Rules & Victory Conditions adapted for AoS4 -->
        <section class="section-block">
            <h2>Special Rules for The Ritual</h2>

            <h3>Ritualist's Command Ability: Destroy At All Costs</h3>
            <p>Your General can use this Command Ability in your **Command Phase**. Pick D3 friendly units from your army that are wholly within 12" of this General. Until the **end of the current battle round**, add 1 to the Hit rolls and subtract 1 from the Save rolls made for these units. This Command Ability can only be used once per battle.</p>

            <h3>Disrupter's Command Ability: Shatter the Artefact</h3>
            <p>Your General (or the designated Second in Command, see below) can use this Command Ability in your **Command Phase**. If they are within 3" of the Artefact terrain feature, roll a D6. On a roll of 2+, the Artefact is shattered. If the Artefact is shattered, the **Disrupter scores an additional 30 Victory Points** at the end of Battle Round 5.</p>

            <h3>Second in Command</h3>
            <p>If the Disrupter's General is slain, they can immediately pick a friendly **HERO** to take their place as the General for the rest of the battle. This replacement can only happen once. If this replacement General is also slain (or if no other HERO is available to replace the original General), then the **Ritualist scores an additional 30 Victory Points** at the end of Battle Round 5.</p>

            <h3>The Ritual</h3>
            <p>The Ritualist rolls a D6 in each of their **Hero Phases**. Add 1 to the roll for each friendly **WIZARD** or **PRIEST** wholly within 12" of the Artefact. Subtract 1 from the roll for each enemy **WIZARD** or **PRIEST** wholly within 36" of the Artefact. The roll cannot be increased beyond 6 or reduced to less than 1. Keep a note of the cumulative sum of these rolls. This cumulative total is used for the 'Ritual Completed!' End-Game Victory Point condition.</p>
        </section>

        <!-- Player Input / Game Tracking Section -->
        <section id="game-controls-section" class="section-block">
            <button class="action-button start-game-button" id="startGameButton">Start New Game!</button>

            <div id="playerSelection" class="player-selection-panel" style="display:none;">
                <h3>Select Players</h3>
                <div class="form-group">
                    <label for="player1Select">Player 1:</label>
                    <select id="player1Select" required>
                        <option value="">-- Select Player 1 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="player2Select">Player 2:</label>
                    <select id="player2Select" required>
                        <option value="">-- Select Player 2 --</option>
                    </select>
                </div>
                <button class="action-button confirm-players-button" id="confirmPlayersButton">Confirm Players</button>
                <p id="playerSelectionError" style="color:red; font-size:0.85em; margin-top:10px; display:none;">Players cannot be the same.</p>
            </div>

            <div id="gameTrackingUI" class="game-tracking-panel" style="display:none;">
                <h3 id="gameTitle">Game in Progress</h3>
                <div class="current-round-display">Round: <span id="currentRound">1</span></div>

                <h4><span id="player1NameDisplay">Player 1</span></h4>
                <div class="form-group">
                    <label for="player1CP">Command Points:</label>
                    <div class="player-score-controls">
                        <button onclick="changeValue('player1CP', -1)">-</button>
                        <input type="number" id="player1CP" value="0" min="0">
                        <button onclick="changeValue('player1CP', 1)">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="player1Score">Victory Points:</label>
                    <div class="player-score-controls">
                        <button onclick="changeValue('player1Score', -1)">-</button>
                        <input type="number" id="player1Score" value="0" min="0">
                        <button onclick="changeValue('player1Score', 1)">+</button>
                    </div>
                </div>

                <h4><span id="player2NameDisplay">Player 2</span></h4>
                <div class="form-group">
                    <label for="player2CP">Command Points:</label>
                    <div class="player-score-controls">
                        <button onclick="changeValue('player2CP', -1)">-</button>
                        <input type="number" id="player2CP" value="0" min="0">
                        <button onclick="changeValue('player2CP', 1)">+</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="player2Score">Victory Points:</label>
                    <div class="player-score-controls">
                        <button onclick="changeValue('player2Score', -1)">-</button>
                        <input type="number" id="player2Score" value="0" min="0">
                        <button onclick="changeValue('player2Score', 1)">+</button>
                    </div>
                </div>
                
                <button class="action-button end-round-button" id="endRoundButton">End Round</button>
                <button class="action-button end-game-button" id="endGameButton">End Game & Submit</button>
            </div>
        </section>

        <!-- Balance Tips Section -->
        <section class="section-block">
            <h2>Balance Tips & Resources</h2>
            <ul>
                <li>For a balanced game, ensure both armies are built to the same agreed-upon points value (e.g., 1000pts, 2000pts).</li>
                <li>Consider the impact of the unique Command Abilities when building your army lists.</li>
                <li>The Disrupter wants to get to the Artefact quickly; the Ritualist wants to control the centre and screen.</li>
                <li><strong>PDF Rules:</strong> <button class="action-button pdf-button" onclick="window.print()">Save this Battleplan as PDF</button></li>
            </ul>
            <div class="notes">
                <strong>Quick tactics:</strong> use your General's unique Command Ability at the opportune moment!
            </div>
        </section>

        <!-- Quick FAQ Section -->
        <section class="section-block">
            <h2>Quick FAQ & Clarifications</h2>
            <button class="collapsible" aria-expanded="false" onclick="toggleCollapsible(this)">What happens if both win conditions are met?</button>
            <div class="content">
                <p>If both Artefact shattered and Ritual completed conditions are met, the player who achieved their condition last (or in the current turn) generally takes precedence for the 30VP. If it's truly simultaneous, consider it a Draw for that specific objective's VP.</p>
            </div>
            <button class="collapsible" aria-expanded="false" onclick="toggleCollapsible(this)">What if the Disrupter has no other HERO?</button>
            <div class="content">
                <p>As per the 'Second in Command' rule, if the Disrupter's General is slain and there are no other eligible HERO units to become the new General, the Ritualist scores an additional 30 Victory Points at the end of Battle Round 5.</p>
            </div>
            <button class="collapsible" aria-expanded="false" onclick="toggleCollapsible(this)">Can units near the Artefact be attacked?</button>
            <div class="content">
                <p>Yes, the Artefact is a piece of Impassable scenery that models cannot move through, but models can be in base contact with it or in its zone (if it has one). Units can fight or shoot at units near/on the Artefact as normal.</p>
            </div>
            <button class="collapsible" aria-expanded="false" onclick="toggleCollapsible(this)">How do Battle Tactics and Grand Strategies work?</button>
            <div class="content">
                <p>Players choose these from the current Core Rules. They provide additional VP. Aim to complete these alongside the battleplan's specific objectives!</p>
            </div>
        </section>

        <div class="call-to-action">
            <a href="aos_campaign.html" class="cta-button">Return to Warband Wars</a>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2018 The Dirty d6 Dozen Wargaming Club. All rights reserved. (hehe)</p>
            <img src="images/Invert_Small_Logo.png" alt="Dirty d6 Dozen Small Logo" class="footer-logo" />
        </div>
    </footer>

    <script>
        // --- Global Variables ---
        let allPlayers = []; // Stores loaded players from players.json
        let gameData = {
            player1: null,
            player2: null,
            currentRound: 1,
            player1CP: 0,
            player1Score: 0, // Player 1's Victory Points
            player2CP: 0,
            player2Score: 0, // Player 2's Victory Points
            battleplan: 'The Ritual' // This scenario's name
        };

        // --- DOM Element References ---
        const startGameButton = document.getElementById('startGameButton');
        const playerSelectionPanel = document.getElementById('playerSelection');
        const player1Select = document.getElementById('player1Select');
        const player2Select = document.getElementById('player2Select');
        const confirmPlayersButton = document.getElementById('confirmPlayersButton');
        const playerSelectionError = document.getElementById('playerSelectionError');
        const gameTrackingUI = document.getElementById('gameTrackingUI');
        const gameTitleDisplay = document.getElementById('gameTitle');
        const currentRoundDisplay = document.getElementById('currentRound');
        const player1NameDisplay = document.getElementById('player1NameDisplay');
        const player2NameDisplay = document.getElementById('player2NameDisplay');
        const player1CPInput = document.getElementById('player1CP');
        const player1ScoreInput = document.getElementById('player1Score');
        const player2CPInput = document.getElementById('player2CP');
        const player2ScoreInput = document.getElementById('player2Score');
        const endRoundButton = document.getElementById('endRoundButton');
        const endGameButton = document.getElementById('endGameButton');

        // --- Utility Functions ---
        function toggleCollapsible(btn){
          const expanded = btn.getAttribute('aria-expanded') === 'true';
          btn.setAttribute('aria-expanded', String(!expanded));
        }

        function changeValue(inputId, delta) {
            const input = document.getElementById(inputId);
            let currentValue = parseInt(input.value) || 0;
            input.value = Math.max(0, currentValue + delta); // Prevent negative scores/CP
        }

        // --- Main Game Logic ---

        // Loads players into dropdowns
        async function loadPlayersIntoDropdowns() {
            try {
                const response = await fetch('players.json'); // Fetch from root
                allPlayers = await response.json();

                // Clear existing options
                player1Select.innerHTML = '<option value="">-- Select Player 1 --</option>';
                player2Select.innerHTML = '<option value="">-- Select Player 2 --</option>';

                allPlayers.forEach(player => {
                    const option1 = document.createElement('option');
                    option1.value = player.id;
                    option1.textContent = `${player.name} (${player.warband_name || player.faction})`;
                    player1Select.appendChild(option1);

                    const option2 = document.createElement('option');
                    option2.value = player.id;
                    option2.textContent = `${player.name} (${player.warband_name || player.faction})`;
                    player2Select.appendChild(option2);
                });

            } catch (error) {
                console.error('Error loading players:', error);
                alert('Failed to load player list. Please try again later.');
                startGameButton.disabled = true; // Disable start game if players can't load
            }
        }

        // Starts the game by showing player selection
        startGameButton.addEventListener('click', () => {
            startGameButton.style.display = 'none';
            playerSelectionPanel.style.display = 'block';
            loadPlayersIntoDropdowns();
        });

        // Confirms player selection and shows game tracking UI
        confirmPlayersButton.addEventListener('click', () => {
            const p1Id = player1Select.value;
            const p2Id = player2Select.value;

            if (!p1Id || !p2Id) {
                playerSelectionError.textContent = 'Please select both players.';
                playerSelectionError.style.display = 'block';
                return;
            }

            if (p1Id === p2Id) {
                playerSelectionError.textContent = 'Players cannot be the same. Please select different players.';
                playerSelectionError.style.display = 'block';
                return;
            }

            playerSelectionError.style.display = 'none';

            // Find selected player objects
            gameData.player1 = allPlayers.find(p => p.id === p1Id);
            gameData.player2 = allPlayers.find(p => p.id === p2Id);

            if (!gameData.player1 || !gameData.player2) {
                playerSelectionError.textContent = 'Selected players not found. Please reload.';
                playerSelectionError.style.display = 'block';
                return;
            }

            // Initialize UI with player names
            player1NameDisplay.textContent = gameData.player1.name;
            player2NameDisplay.textContent = gameData.player2.name;
            gameTitleDisplay.textContent = `${gameData.player1.name} (${gameData.player1.warband_name || gameData.player1.faction}) vs ${gameData.player2.name} (${gameData.player2.warband_name || gameData.player2.faction})`;


            // Hide player selection, show game tracking
            playerSelectionPanel.style.display = 'none';
            gameTrackingUI.style.display = 'block';
        });

        // Ends a round, increments round counter
        endRoundButton.addEventListener('click', () => {
            gameData.currentRound++;
            currentRoundDisplay.textContent = gameData.currentRound;
            alert(`Round ${gameData.currentRound - 1} ended. Starting Round ${gameData.currentRound}.`);
        });

        // Ends the game and prepares for submission
        endGameButton.addEventListener('click', () => {
            const confirmEnd = confirm("Are you sure you want to end the game and submit results?");
            if (!confirmEnd) return;

            // Capture final scores
            gameData.player1CP = parseInt(player1CPInput.value);
            gameData.player1Score = parseInt(player1ScoreInput.value); // Player 1's FINAL VP
            gameData.player2CP = parseInt(player2CPInput.value);
            gameData.player2Score = parseInt(player2ScoreInput.value); // Player 2's FINAL VP

            // Prepare data for submission page (simplified to just player IDs and scores)
            const submissionData = {
                player1_id: gameData.player1.id,
                player1_name: gameData.player1.name,
                player1_score: gameData.player1Score, 
                
                player2_id: gameData.player2.id,
                player2_name: gameData.player2.name,
                player2_score: gameData.player2Score,

                battleplan_name: gameData.battleplan, // This will be 'The Ritual'
                total_rounds: gameData.currentRound // Total rounds played
            };

            // Store submission data in sessionStorage to pass to submit_game.html
            sessionStorage.setItem('gameSubmissionData', JSON.stringify(submissionData));

            // Redirect to the submission page
            window.location.href = 'submit_game.html';
        });

        // --- Initialization on Page Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const collapsibles = document.querySelectorAll('.collapsible');
            collapsibles.forEach(btn => {
              btn.addEventListener('click', () => toggleCollapsible(btn));
            });
        });
    </script>
</body>
</html>